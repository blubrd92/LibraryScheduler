{<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Scheduler</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { 
            --primary: #2c3e50; 
            --light: #f8f9fa; 
            --border: #dee2e6; 
            --danger: #c0392b; 
            --success: #27ae60;
            
            /* Two-Tone Alternating Palette */
            --app-color-1: #5c6bc0; /* Soft Indigo */
            --app-color-2: #26a69a; /* Calm Teal */
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #fff; color: #333; }
        
        /* Utility */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .gap { gap: 10px; }

        /* Status Bar */
        #status-bar { font-size: 0.8rem; padding: 5px; text-align: right; color: #999; margin-bottom: 10px;}
        .online { color: var(--success); font-weight: bold; }
        .offline { color: var(--danger); font-weight: bold; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 3px solid var(--primary); padding-bottom: 15px; }
        .header-title h2 { margin: 0; font-size: 1.8rem; color: var(--primary); }
        .header-title small { font-size: 1rem; color: #666; font-weight: normal; margin-left: 10px; }
        
        /* Controls */
        button { cursor: pointer; padding: 8px 14px; border: 1px solid #ccc; border-radius: 4px; background: var(--light); transition: 0.2s; font-weight: 600; }
        button:hover { background: #e2e6ea; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-success { background: var(--success); color: white; border: none; }
        .btn-danger { background: white; color: var(--danger); border: 1px solid var(--danger); }
        .btn-nav { font-weight: bold; width: 40px; text-align: center; }
        select, input[type="date"], input[type="text"], input[type="number"], input[type="password"] { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; }

        /* Grid */
        .grid-container { display: grid; grid-template-columns: 85px repeat(7, 1fr); border: 1px solid var(--border); height: 75vh; overflow-y: auto; position: relative; background: #fff; }
        .header-cell { background: var(--primary); color: white; padding: 10px 5px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 10; border-right: 1px solid rgba(255,255,255,0.2); }
        
        /* Row Banding */
        .row-alt { background-color: #fafafa; }

        /* Time Cell Styling */
        .time-cell { 
            display: flex; align-items: center; justify-content: center;
            font-size: 0.95em; font-weight: bold; color: #555; 
            border-bottom: 1px solid #eee; border-right: 2px solid #ddd; 
            background: #fff; position: sticky; left: 0; z-index: 5; 
        }
        .time-cell.row-alt { background-color: #fafafa; }
        
        /* Slots */
        .slot { 
            border-bottom: 1px dotted #eee; 
            border-right: 1px solid #eee; 
            padding: 2px; 
            font-size: 0.95em; 
            min-height: 25px; 
            cursor: pointer; 
            position: relative; 
            transition: background 0.1s; 
            box-sizing: border-box; /* Ensures padding doesn't affect width/height calculations */
        }
        
        .slot:not(.booked-head):not(.booked-body):not(.closed):hover { background-color: #e3f2fd; }
        
        .slot:not(.booked-head):not(.booked-body):not(.closed):hover::after {
            content: attr(data-time);
            position: absolute;
            bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 4px 8px; border-radius: 4px;
            font-size: 0.85em; white-space: nowrap; pointer-events: none; z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .slot.closed { background-color: #eeeeee !important; cursor: not-allowed; opacity: 1; pointer-events: none; }
        
        /* === UPDATED BOOKING STYLES === 
           These are the specific fixes for the merging issue
        */
        .slot.booked-head { 
            color: white; 
            border-radius: 4px; 
            padding: 6px 8px; 
            font-weight: 600; 
            z-index: 2; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            
            /* Flexbox to manage vertical content */
            display: flex;
            flex-direction: column; 
            align-items: flex-start; /* Align text to left */
            justify-content: flex-start; /* Start text at top */
            height: 100%; /* Force it to fill the spanned grid rows */
            overflow: hidden; /* Clean edges */
        }
        
        .slot.booked-body { display: none; } /* Ensure we never see these if JS fails to hide them */
        
        .slot.booked-head.with-staff { border-left: 5px solid #f1c40f; } 
        
        .booking-hover-effect {
            opacity: 1 !important;
            filter: brightness(1.1) saturate(1.1); 
            z-index: 15;
        }

        .bg-color-0 { background-color: var(--app-color-1); }
        .bg-color-1 { background-color: var(--app-color-2); }
        
        /* === UPDATED TEXT STYLES === 
           Allows text to wrap and fill the space
        */
        .slot-name { 
            display: block; 
            width: 100%;
            white-space: normal; /* CRITICAL: Allows text to wrap */
            word-break: break-word; /* Prevents long words from breaking layout */
            overflow: visible; /* Let text show */
            font-size: 0.95em; 
            line-height: 1.3;
        }
        .slot-staff { 
            font-size: 0.9em; 
            color: rgba(255,255,255,0.9); 
            font-style: italic; 
            display: block; 
            margin-top: 2px; /* Just a tiny gap */
        }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 400px; max-width: 90%; box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #555; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; box-sizing: border-box; }
        
        /* LOGIN SCREEN */
        #loginOverlay { display: flex; position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); z-index: 5000; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .login-box { background: white; padding: 40px; border-radius: 8px; width: 300px; text-align: center; color: #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-box h2 { margin-top: 0; color: var(--primary); }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; font-size: 1.1rem; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: var(--success); color: white; font-size: 1.1rem; border: none; border-radius: 4px; cursor: pointer; }
        .login-box button:hover { background: #219150; }

        /* Admin Styles */
        .settings-box { background: white; padding: 0; width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 8px; }
        .settings-header { background: var(--primary); color: white; padding: 15px 25px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .settings-body { padding: 25px; }
        .resource-manager { background: #eef2f7; padding: 15px; border-radius: 6px; border: 1px solid #d1d9e6; margin-bottom: 20px; }
        .day-config-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .day-box { text-align: center; font-size: 0.8em; border: 1px solid #ccc; padding: 5px; border-radius: 4px; background: #fff; }
        .day-box input { text-align: center; margin-bottom: 2px; border: 1px solid #eee; }
        .day-box strong { display: block; margin-bottom: 4px; color: var(--accent); }
        .settings-row-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 15px; }
        .settings-row-grid input, .settings-row-grid select { width: 100%; box-sizing: border-box; }

        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.8); z-index: 2000; display:flex; justify-content:center; align-items:center; font-size: 2rem; color: var(--primary); font-weight:bold; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>Library Staff Login</h2>
        <p>Please enter the shared access code.</p>
        <input type="password" id="loginPass" placeholder="Password" onkeydown="if(event.key==='Enter') doLogin()">
        <button onclick="doLogin()">Unlock Scheduler</button>
        <p id="loginError" style="color:red; display:none; margin-top:10px;">Incorrect Password</p>
    </div>
</div>

<div id="loading" class="loading-overlay hidden">Saving...</div>

<div id="status-bar">Waiting for Login...</div>

<header>
    <div class="header-title">
        <h2 id="headerResourceName">Scheduler</h2>
        <span id="rangeDisplay"></span>
    </div>

    <div class="flex gap">
        <select id="resourceSelect" onchange="handleResourceChange()"></select>
        
        <button class="btn-nav" onclick="navigateTime(-1)">&#8592;</button>
        <div class="date-picker-wrapper">
            <input type="date" id="datePicker" onchange="handleDatePick()">
        </div>
        <button class="btn-nav" onclick="navigateTime(1)">&#8594;</button>
        
        <div style="width: 1px; height: 30px; background: #ccc; margin: 0 10px;"></div>
        <button class="btn-primary" onclick="openAdminPanel()">⚙ Admin</button>
        <button class="btn-danger" onclick="doLogout()">Logout</button>
    </div>
</header>

<div id="gridContainer" class="grid-container"></div>

<div id="bookingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Booking Details</div>
        <input type="hidden" id="slotId">
        <input type="hidden" id="subRoomIndex">
        
        <div class="form-group">
            <label>Duration</label>
            <select id="bookDuration"></select>
        </div>
        
        <div class="form-group">
            <label>Patron/Event Name</label>
            <input type="text" id="bookName" placeholder="e.g. John Doe">
        </div>
        
        <div class="form-group" id="staffSection" style="display:none; background: #fff8e1; padding: 10px; border-radius: 4px; border: 1px solid #ffe082;">
            <div class="flex gap">
                <input type="checkbox" id="bookHasStaff" onchange="toggleStaffInput()" style="width:auto;">
                <label for="bookHasStaff" style="margin:0; font-weight:normal; cursor:pointer;">Staff Assistance Required?</label>
            </div>
            <div id="staffInputContainer" class="hidden" style="margin-top: 10px;">
                <label style="font-size:0.8em; color:#666;">Assigned Staff Member:</label>
                <input type="text" id="bookStaffName" placeholder="e.g. Terra">
            </div>
        </div>
        
        <div class="form-group">
            <label>Notes (Internal)</label>
            <textarea id="bookNotes" rows="3"></textarea>
            <div style="margin-top: 5px; display:flex; align-items:center; gap:5px;">
                <input type="checkbox" id="bookShowNotes" style="width:auto;">
                <label for="bookShowNotes" style="margin:0; font-size:0.9em; font-weight:normal; cursor:pointer;">Show on Grid?</label>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
            <button class="btn-success" onclick="saveBooking()">Save Booking</button>
            <button class="btn-danger" onclick="deleteBooking()">Delete</button>
            <button onclick="closeModal('bookingModal')">Cancel</button>
        </div>
    </div>
</div>

<div id="settingsOverlay" class="modal">
    <div class="settings-box">
        <div class="settings-header">
            <span>Admin Configuration</span>
            <button onclick="closeModal('settingsOverlay')" style="background:transparent; border:none; color:white; font-size:1.5rem;">&times;</button>
        </div>
        <div class="settings-body">
            
            <div class="resource-manager">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Manage Resources:</label>
                <div class="flex gap">
                    <select id="settingResSelect" onchange="loadSettingsForEditor()" style="flex-grow:1;"></select>
                    <button class="btn-success" onclick="addNewResource()">+ New Resource</button>
                    <button class="btn-danger" onclick="deleteResource()">Delete</button>
                </div>
            </div>

            <div style="border-top: 1px solid #eee; padding-top: 15px;">
                <div class="settings-row-grid">
                    <div>
                        <label>Resource Name</label>
                        <input type="text" id="editResName">
                    </div>
                    <div>
                        <label>Max Hours</label>
                        <input type="number" id="editMaxDuration" step="0.5">
                    </div>
                </div>

                <div class="form-group" style="background: #e3f2fd; padding: 10px; border-radius: 4px; border: 1px solid #bbdefb;">
                    <label>View Mode</label>
                    <select id="editViewMode" onchange="toggleSubRoomInput()">
                        <option value="week">Weekly Grid (Standard)</option>
                        <option value="day">Day View (Multi-Room)</option>
                    </select>
                    
                    <div id="subRoomConfig" class="hidden" style="margin-top:10px;">
                        <label>Sub-Rooms / Columns (Comma Separated)</label>
                        <input type="text" id="editSubRooms" placeholder="e.g. Pod A, Pod B, Pod C">
                        <small style="color:#666">These will appear as columns in Day View.</small>
                    </div>
                </div>
                
                <div class="form-group" style="background: #f0f8ff; padding: 10px; border-radius: 4px; border: 1px solid #d0e1f5;">
                    <div class="flex gap">
                        <input type="checkbox" id="editResOrientation" style="width:auto;">
                        <label for="editResOrientation" style="margin:0; cursor:pointer;">Enable "Staff Assistance" Fields?</label>
                    </div>
                </div>

                <div class="form-group">
                    <h4 style="margin: 15px 0 5px 0; border-bottom: 2px solid #eee; padding-bottom:5px;">Operating Hours (24h Format)</h4>
                    <div class="day-config-grid" id="daysConfigContainer"></div>
                </div>
            </div>
            
            <div style="text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <button class="btn-primary" onclick="saveAllSettings()" style="width: 200px; padding: 12px;">SAVE CHANGES</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyAKLTLBTH5KaJ0DiK2AUphu1w80yJwUwTI",
  authDomain: "libraryscheduler-faf2f.firebaseapp.com",
  projectId: "libraryscheduler-faf2f",
  storageBucket: "libraryscheduler-faf2f.firebasestorage.app",
  messagingSenderId: "286899383584",
  appId: "1:286899383584:web:5826c1297f3c5bd28afb45"
};
    // --- END CONFIG ---

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // SYSTEM EMAIL - HARDCODED (Staff only needs to know the password)
    const STAFF_EMAIL = "staff@library.internal"; 
    const ADMIN_PASS = "library"; // Re-added for Admin Panel protection

    const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const DEFAULT_HOURS = [0,0, 10,18, 10,20, 10,18, 10,18, 10,17, 10,17]; 

    // STATE
    let resources = [];
    let currentResId = null;
    let pendingSelectionId = null;
    let currentWeekStart = new Date(); 
    let currentDayDate = new Date();   
    let allBookings = {}; 
    let dailyMap = []; 
    let bookingColorMap = {};

    function init() {
        // Date Setup
        const d = new Date();
        const day = d.getDay();
        const diff = d.getDate() - day; 
        const weekStart = new Date(d);
        weekStart.setDate(diff);
        weekStart.setHours(0,0,0,0);
        currentWeekStart = weekStart;
        
        currentDayDate = new Date();
        currentDayDate.setHours(0,0,0,0);

        // AUTH LISTENER
        auth.onAuthStateChanged(user => {
            if (user) {
                // Logged In
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('status-bar').innerHTML = "<span class='online'>● Connected (Staff)</span>";
                setupRealtimeListeners();
            } else {
                // Logged Out
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('status-bar').innerHTML = "<span class='offline'>Locked</span>";
            }
        });
    }

    // --- AUTH ACTIONS ---
    function doLogin() {
        const pass = document.getElementById('loginPass').value;
        const err = document.getElementById('loginError');
        err.style.display = 'none';
        
        auth.signInWithEmailAndPassword(STAFF_EMAIL, pass)
            .catch(error => {
                err.style.display = 'block';
                err.innerText = "Error: " + error.message;
            });
    }

    function doLogout() {
        auth.signOut();
        location.reload();
    }

    function setupRealtimeListeners() {
        db.collection('system').doc('resources').onSnapshot((doc) => {
            if (doc.exists) {
                resources = doc.data().list || [];
            } else {
                resources = [{ id: 'res_default', name: 'General Area', viewMode: 'week', hours: DEFAULT_HOURS }];
                db.collection('system').doc('resources').set({ list: resources });
            }
            handleResourceUpdate();
        }, (err) => alert("Permissions Error: " + err.message));

        db.collection('appointments').onSnapshot((snapshot) => {
            allBookings = {};
            snapshot.forEach((doc) => { allBookings[doc.id] = doc.data(); });
            renderGrid();
        });
    }

    // --- CORE LOGIC (UNCHANGED) ---
    function handleResourceUpdate() {
        const mainSel = document.getElementById('resourceSelect');
        const adminSel = document.getElementById('settingResSelect');
        
        const populate = (sel, selectedId) => {
            sel.innerHTML = '';
            resources.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.innerText = r.name;
                sel.appendChild(opt);
            });
            if (selectedId && resources.find(r => r.id === selectedId)) sel.value = selectedId;
        };

        if (!currentResId && resources.length > 0) currentResId = resources[0].id;
        populate(mainSel, currentResId);

        let adminVal = adminSel.value;
        if (pendingSelectionId) { adminVal = pendingSelectionId; pendingSelectionId = null; } 
        else if (!adminVal && resources.length > 0) { adminVal = resources[0].id; }
        populate(adminSel, adminVal);

        updateUIControls();
        renderGrid();
        if(document.getElementById('settingsOverlay').style.display !== 'none') loadSettingsForEditor();
    }

    function navigateTime(dir) {
        const res = resources.find(r => r.id === currentResId);
        const isDayView = res && res.viewMode === 'day';
        if (isDayView) {
            currentDayDate.setDate(currentDayDate.getDate() + dir);
            const d = new Date(currentDayDate);
            const day = d.getDay();
            const diff = d.getDate() - day;
            currentWeekStart = new Date(d.setDate(diff));
        } else {
            currentWeekStart.setDate(currentWeekStart.getDate() + (dir * 7));
            currentDayDate = new Date(currentWeekStart);
        }
        updateUIControls();
        renderGrid();
    }

    function handleDatePick() {
        const raw = document.getElementById('datePicker').value;
        if(!raw) return;
        const rawDate = new Date(raw + 'T00:00');
        currentDayDate = new Date(rawDate);
        const day = rawDate.getDay();
        const diff = rawDate.getDate() - day;
        currentWeekStart = new Date(rawDate.setDate(diff));
        updateUIControls();
        renderGrid();
    }

    function updateUIControls() {
        const res = resources.find(x => x.id === currentResId);
        if(!res) return;
        const isDayView = res.viewMode === 'day';
        
        if (isDayView) {
            const d = currentDayDate;
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('rangeDisplay').innerText = d.toLocaleDateString('en-US', options);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            document.getElementById('datePicker').value = `${y}-${m}-${day}`;
        } else {
            const endWeek = new Date(currentWeekStart);
            endWeek.setDate(endWeek.getDate() + 6);
            document.getElementById('rangeDisplay').innerText = `${formatDateShort(currentWeekStart)} — ${formatDateShort(endWeek)}`;
            const y = currentWeekStart.getFullYear();
            const m = String(currentWeekStart.getMonth() + 1).padStart(2, '0');
            const d = String(currentWeekStart.getDate()).padStart(2, '0');
            document.getElementById('datePicker').value = `${y}-${m}-${d}`;
        }
        document.getElementById('headerResourceName').innerHTML = res.name;
    }

    function renderGrid() {
        const container = document.getElementById('gridContainer');
        container.innerHTML = '';
        const res = resources.find(r => r.id === currentResId);
        if(!res) return;
        const isDayView = res.viewMode === 'day';
        
        let columns = []; 
        if (isDayView) {
            const dayIdx = currentDayDate.getDay(); 
            const subRooms = res.subRooms ? res.subRooms.split(',').map(s => s.trim()).filter(s => s) : ['Main'];
            container.style.gridTemplateColumns = `85px repeat(${subRooms.length}, 1fr)`;
            subRooms.forEach((name, idx) => {
                columns.push({ header: name, date: currentDayDate, dayIndex: dayIdx, subIndex: idx });
            });
        } else {
            container.style.gridTemplateColumns = `85px repeat(7, 1fr)`;
            DAYS.forEach((name, i) => {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                columns.push({ header: `${name} <br><small style="font-weight:normal">${d.getMonth()+1}/${d.getDate()}</small>`, date: d, dayIndex: i, subIndex: null });
            });
        }

        container.appendChild(createDiv('header-cell', 'Time'));
        columns.forEach(col => { container.appendChild(createDiv('header-cell', col.header)); });

        const activeWeekKey = getWeekKey(isDayView ? currentDayDate : currentWeekStart);
        let gridBookings = [];
        Object.keys(allBookings).forEach(key => {
            if (key.startsWith(res.id + "_" + activeWeekKey)) {
                const prefix = res.id + "_";
                const suffix = key.substring(prefix.length); 
                const parts = suffix.split('_');
                const bkDayIdx = parseInt(parts[1]);
                const bkStart = parseFloat(parts[2]);
                const bkSubIdx = parts[3] ? parseInt(parts[3]) : null;
                gridBookings.push({ id: key, dayIndex: bkDayIdx, start: bkStart, end: bkStart + parseFloat(allBookings[key].duration), subIndex: bkSubIdx, data: allBookings[key] });
            }
        });

        bookingColorMap = {};
        let colGroups = {};
        gridBookings.forEach(b => {
            const k = b.dayIndex + "-" + (b.subIndex !== null ? b.subIndex : 'x');
            if(!colGroups[k]) colGroups[k] = [];
            colGroups[k].push(b);
        });
        Object.values(colGroups).forEach(group => {
            group.sort((a,b) => a.start - b.start);
            group.forEach((b, i) => bookingColorMap[b.id] = i % 2);
        });

        let minH = 24, maxH = 0;
        for(let i=0; i<14; i+=2) {
            if(res.hours[i] !== res.hours[i+1]) {
                if(res.hours[i] < minH) minH = res.hours[i];
                if(res.hours[i+1] > maxH) maxH = res.hours[i+1];
            }
        }
        if(minH > maxH) { minH = 9; maxH = 17; }

        const totalSlots = (maxH - minH) * 2;
        for (let i = 0; i < totalSlots; i++) {
            const timeVal = minH + (i * 0.5);
            const displayTime = formatTime(timeVal);
            const isAltRow = (i % 2 === 1);
            const rowClass = isAltRow ? 'row-alt' : '';
            
            container.appendChild(createDiv(`time-cell ${rowClass}`, displayTime));

            columns.forEach(col => {
                const dayStart = res.hours[col.dayIndex * 2];
                const dayEnd = res.hours[(col.dayIndex * 2) + 1];
                const slot = document.createElement('div');
                slot.className = `slot ${rowClass}`;
                
                if (timeVal < dayStart || timeVal >= dayEnd || dayStart === dayEnd) {
                    slot.classList.add('closed');
                    container.appendChild(slot);
                } else {
                    const booking = gridBookings.find(b => b.dayIndex === col.dayIndex && (b.subIndex === col.subIndex) && timeVal >= b.start && timeVal < b.end);
                    if (booking) {
                        const colorIndex = bookingColorMap[booking.id];
                        const colorClass = `bg-color-${colorIndex}`;
                        slot.dataset.bid = booking.id;
                        slot.onmouseenter = () => highlightBooking(booking.id);
                        slot.onmouseleave = () => unhighlightBooking(booking.id);

                        if (timeVal === booking.start) {
                            // MERGED CELL LOGIC
                            // 1. Calculate how many 30min slots this booking takes
                            const spanCount = booking.data.duration * 2; 
                            slot.style.gridRow = `span ${spanCount}`;
                            slot.style.height = "100%"; // Force height to fill the span
                            
                            // 2. Style it as a single block (reusing booked-head class but updated styles)
                            slot.className = `slot ${rowClass} booked-head ${colorClass}`;
                            if(booking.data.hasStaff) slot.classList.add('with-staff');
                            
                            slot.innerHTML = `<span class="slot-name">${booking.data.name} <span style="font-weight:normal; font-size:0.9em; opacity:0.9">(${formatTime(booking.start)} - ${formatTime(booking.end)})</span></span>`;
                            if(booking.data.hasStaff) slot.innerHTML += `<span class="slot-staff">w/ ${booking.data.staffName}</span>`;
                            if(booking.data.showNotes && booking.data.notes) {
                                slot.innerHTML += `<span style="display:block; font-size:0.85em; margin-top:4px; opacity:0.9; border-top:1px solid rgba(255,255,255,0.2); padding-top:2px;">${booking.data.notes}</span>`;
                            }
                            slot.onclick = () => openBookingModal(booking.id, booking.data, col.subIndex);
                            container.appendChild(slot);
                        } else {
                            // 3. Skip rendering slots for the rest of the booking duration
                            // The 'span' from the head will fill this space in the grid.
                            return; 
                        }
                    } else {
                        let emptyId = `${res.id}_${activeWeekKey}_${col.dayIndex}_${timeVal}`;
                        if (col.subIndex !== null) emptyId += `_${col.subIndex}`;
                        slot.onclick = () => openBookingModal(emptyId, null, col.subIndex);
                        slot.setAttribute('data-time', displayTime);
                        container.appendChild(slot);
                    }
                }
                
            });
        }
    }

    // --- MODAL & SAVE ---
    function openBookingModal(slotId, data, subIdx) {
        const modal = document.getElementById('bookingModal');
        const res = resources.find(r => r.id === currentResId);
        
        const prefix = res.id + "_";
        const suffix = slotId.substring(prefix.length); 
        const parts = suffix.split('_');
        
        let start, dayIdx;
        if (data) {
             dayIdx = parseInt(parts[1]);
             start = parseFloat(parts[2]);
             document.getElementById('subRoomIndex').value = parts[3] || ''; 
        } else {
             // New booking
             dayIdx = parseInt(parts[1]);
             start = parseFloat(parts[2]);
             document.getElementById('subRoomIndex').value = (subIdx !== null && subIdx !== undefined) ? subIdx : '';
        }

        const dayEnd = res.hours[(dayIdx * 2) + 1];
        const activeWeekKey = parts[0];
        const currentSubIdx = document.getElementById('subRoomIndex').value;
        let conflictingStarts = [];
        
        Object.keys(allBookings).forEach(k => {
             if (k.startsWith(res.id + "_" + activeWeekKey) && k !== slotId) {
                 const pSuffix = k.substring(prefix.length);
                 const p = pSuffix.split('_');
                 const bDay = parseInt(p[1]);
                 const bStart = parseFloat(p[2]);
                 const bSub = p[3]; 
                 
                 if (bDay === dayIdx) {
                     const subMatch = (bSub == currentSubIdx) || (!bSub && !currentSubIdx);
                     if (subMatch) { if (bStart > start) conflictingStarts.push(bStart); }
                 }
             }
        });
        
        conflictingStarts.sort((a,b)=>a-b);
        const nextStart = conflictingStarts.length > 0 ? conflictingStarts[0] : dayEnd;
        const maxAvailable = nextStart - start;
        const limit = Math.min(maxAvailable, res.maxDuration);

        document.getElementById('slotId').value = slotId;
        document.getElementById('bookName').value = data ? data.name : '';
        document.getElementById('bookNotes').value = data ? data.notes : '';
        document.getElementById('bookShowNotes').checked = data ? (data.showNotes || false) : false;
        
        const showStaff = res.hasStaffField;
        document.getElementById('staffSection').style.display = showStaff ? 'block' : 'none';
        if(data) {
             document.getElementById('bookHasStaff').checked = data.hasStaff;
             document.getElementById('bookStaffName').value = data.staffName || '';
        } else {
             document.getElementById('bookHasStaff').checked = false;
             document.getElementById('bookStaffName').value = '';
        }
        toggleStaffInput();

        const durSel = document.getElementById('bookDuration');
        durSel.innerHTML = '';
        const maxIterations = res.maxDuration * 2; 
        for(let i=1; i<=maxIterations; i++) {
            const val = i*0.5;
            if (val > limit && (!data || data.duration !== val)) continue;
            const opt = document.createElement('option');
            opt.value = val;
            opt.innerText = val + (val === 1 ? " Hour" : " Hours");
            if(data && data.duration == val) opt.selected = true;
            durSel.appendChild(opt);
        }
        if(durSel.options.length === 0) { const opt = document.createElement('option'); opt.innerText = "No time available"; durSel.appendChild(opt); }
        modal.style.display = 'flex';
    }

    async function saveBooking() {
        const slotId = document.getElementById('slotId').value;
        const name = document.getElementById('bookName').value;
        const duration = parseFloat(document.getElementById('bookDuration').value);
        if(!name.trim()) return alert("Please enter a name.");
        if(isNaN(duration)) return alert("Invalid duration.");

        const hasStaff = document.getElementById('bookHasStaff').checked;
        const staffName = document.getElementById('bookStaffName').value;
        if (document.getElementById('staffSection').style.display !== 'none' && hasStaff && !staffName.trim()) {
            return alert("Staff Name is required.");
        }

        const showNotes = document.getElementById('bookShowNotes').checked;
        const res = resources.find(r => r.id === currentResId);
        const prefix = res.id + "_";
        const suffix = slotId.substring(prefix.length); 
        const parts = suffix.split('_');
        const start = parseFloat(parts[2]);
        const dayIdx = parseInt(parts[1]);
        const dayEnd = res.hours[(dayIdx * 2) + 1];
        if (start + duration > dayEnd) return alert("Exceeds closing time.");

        const data = { name: name, notes: document.getElementById('bookNotes').value, duration: duration, hasStaff: hasStaff, staffName: staffName, showNotes: showNotes };
        showLoading(true);
        try { await db.collection('appointments').doc(slotId).set(data); closeModal('bookingModal'); } catch(e) { alert("Error: " + e.message); }
        showLoading(false);
    }

    function openAdminPanel() { 
        const pass = prompt("Enter Admin Password:");
        if (pass !== ADMIN_PASS) return pass ? alert("Incorrect Password.") : null;
        document.getElementById('settingsOverlay').style.display = 'flex'; 
        document.getElementById('settingResSelect').value = currentResId; 
        loadSettingsForEditor(); 
    }
    
    function loadSettingsForEditor() {
        const editId = document.getElementById('settingResSelect').value;
        const r = resources.find(x => x.id === editId);
        if(!r) return;
        document.getElementById('editResName').value = r.name;
        document.getElementById('editMaxDuration').value = r.maxDuration;
        document.getElementById('editResOrientation').checked = r.hasStaffField || false;
        document.getElementById('editViewMode').value = r.viewMode || 'week';
        document.getElementById('editSubRooms').value = r.subRooms || '';
        toggleSubRoomInput();
        const container = document.getElementById('daysConfigContainer');
        container.innerHTML = '';
        DAYS.forEach((d, i) => {
            const start = r.hours[i*2];
            const end = r.hours[(i*2)+1];
            container.innerHTML += `<div class="day-box"><strong>${d}</strong><input type="number" id="s_${i}" value="${start}" min="0" max="24"><input type="number" id="e_${i}" value="${end}" min="0" max="24"></div>`;
        });
    }
    function toggleSubRoomInput() { const mode = document.getElementById('editViewMode').value; const container = document.getElementById('subRoomConfig'); if (mode === 'day') { container.classList.remove('hidden'); } else { container.classList.add('hidden'); } }
    async function addNewResource() {
        const name = prompt("Name for new resource?");
        if(!name) return;
        showLoading(true);
        const newRes = { id: 'res-' + Date.now(), name: name, viewMode: 'week', hasStaffField: false, maxDuration: 2, hours: [...DEFAULT_HOURS] };
        try { await db.collection('system').doc('resources').set({ list: [...resources, newRes] }); pendingSelectionId = newRes.id; } catch (e) { alert("Error: " + e.message); }
        showLoading(false);
    }
    async function deleteResource() {
        const delId = document.getElementById('settingResSelect').value;
        if(!delId || !confirm("Delete this resource?")) return;
        showLoading(true);
        try { await db.collection('system').doc('resources').set({ list: resources.filter(r => r.id !== delId) }); } catch (e) { alert("Error: " + e.message); }
        showLoading(false);
    }
    async function saveAllSettings() {
        const editId = document.getElementById('settingResSelect').value;
        const r = resources.find(x => x.id === editId);
        if(!r) return;
        const updatedList = JSON.parse(JSON.stringify(resources));
        const target = updatedList.find(x => x.id === editId);
        target.name = document.getElementById('editResName').value;
        target.maxDuration = parseFloat(document.getElementById('editMaxDuration').value) || 2;
        target.hasStaffField = document.getElementById('editResOrientation').checked;
        target.viewMode = document.getElementById('editViewMode').value;
        target.subRooms = document.getElementById('editSubRooms').value;
        for(let i=0; i<7; i++) { target.hours[i*2] = parseInt(document.getElementById(`s_${i}`).value) || 0; target.hours[(i*2)+1] = parseInt(document.getElementById(`e_${i}`).value) || 0; }
        showLoading(true);
        try { await db.collection('system').doc('resources').set({ list: updatedList }); alert("Settings Saved!"); } catch (e) { alert("Error: " + e.message); }
        showLoading(false);
    }
    
    function handleResourceChange() { currentResId = document.getElementById('resourceSelect').value; updateUIControls(); renderGrid(); }
    function highlightBooking(id) { document.querySelectorAll(`.slot[data-bid="${id}"]`).forEach(s => s.classList.add('booking-hover-effect')); }
    function unhighlightBooking(id) { document.querySelectorAll(`.slot[data-bid="${id}"]`).forEach(s => s.classList.remove('booking-hover-effect')); }
    function deleteBooking() { 
        const slotId = document.getElementById('slotId').value;
        if(!allBookings[slotId]) return closeModal('bookingModal');
        if(confirm("Delete booking?")) { showLoading(true); db.collection('appointments').doc(slotId).delete().then(()=>closeModal('bookingModal')); showLoading(false); }
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function createDiv(cls, content) { const d = document.createElement('div'); d.className = cls; d.innerHTML = content; return d; }
    function showLoading(show) { document.getElementById('loading').className = show ? 'loading-overlay' : 'loading-overlay hidden'; }
    function toggleStaffInput() { const isChecked = document.getElementById('bookHasStaff').checked; document.getElementById('staffInputContainer').classList.toggle('hidden', !isChecked); }
    function getWeekKey(d) {
        const d2 = new Date(d);
        const day = d2.getDay();
        const diff = d2.getDate() - day;
        const s = new Date(d2.setDate(diff));
        return `${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,'0')}-${String(s.getDate()).padStart(2,'0')}`;
    }
    function formatDateShort(d) { return (d.getMonth()+1) + "/" + d.getDate(); }
    function formatTime(val) {
        const h = Math.floor(val);
        const m = (val % 1 === 0) ? '00' : '30';
        const suffix = h >= 12 ? 'pm' : 'am';
        const h12 = h % 12 || 12;
        return `${h12}:${m}${suffix}`;
    }

    init();
</script>
</body>

</html>




